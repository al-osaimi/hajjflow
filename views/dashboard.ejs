<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HajjFlow Dashboard</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #0f172a; }
    ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #334155; }

    #map { height: 100%; }
    .glass { background: rgba(15, 23, 42, 0.65); backdrop-filter: blur(12px); }
    .sidebar-expanded { width: 380px; }
    .sidebar-collapsed { width: 72px; }
    .main-expanded { margin-left: 380px; }
    .main-collapsed { margin-left: 72px; }
    @media (max-width: 1024px) {
      .sidebar-expanded, .sidebar-collapsed { width: 72px; position: fixed; height: 100%; z-index: 40; }
      .main-expanded, .main-collapsed { margin-left: 0 !important; }
      #deviceList { display: none; }
      #sidebarControls { display: none; }
    }
  </style>
</head>

<body class="min-h-screen bg-slate-950 text-slate-100 overflow-hidden">
  <!-- Sidebar -->
  <aside id="sidebar" class="fixed top-0 left-0 h-full bg-slate-900/90 border-r border-slate-800 sidebar-expanded transition-all duration-300 z-50 flex flex-col">
    <div class="p-5 border-b border-slate-800 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="p-2 bg-emerald-500/20 rounded-xl">
          <i class="fa-solid fa-shield-halved text-xl text-emerald-400"></i>
        </div>
        <h1 id="logoText" class="text-xl font-bold">HajjFlow</h1>
      </div>
      <button id="toggleSidebar" class="p-2 rounded-xl hover:bg-slate-800 transition-all">
        <i class="fa-solid fa-chevron-left text-lg"></i>
      </button>
    </div>

    <div id="sidebarControls" class="p-4 space-y-4">
      <div class="relative">
        <input id="search" class="w-full bg-slate-900/70 border border-slate-800 rounded-xl pl-10 pr-4 py-2.5 text-sm outline-none focus:border-slate-600" placeholder="Search device / zone..." />
        <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"></i>
      </div>

      <select id="sortBy" class="w-full bg-slate-900/70 border border-slate-800 rounded-xl px-4 py-2.5 text-sm outline-none focus:border-slate-600">
        <option value="pressure">Sort: Pressure</option>
        <option value="count">Sort: Count</option>
        <option value="name">Sort: Name</option>
        <option value="seen">Sort: Last Seen</option>
      </select>

      <label class="flex items-center gap-2 text-sm text-slate-300 select-none cursor-pointer">
        <input id="onlyOnline" type="checkbox" class="w-4 h-4 accent-emerald-500 rounded">
        Online only
      </label>

      <div class="flex gap-2">
        <button class="filter flex-1 px-3 py-2 rounded-xl border border-slate-800 bg-slate-900/70 hover:bg-slate-800 text-sm flex items-center justify-center gap-1 ring-2 ring-slate-400" data-mode="all">
          <i class="fa-solid fa-filter"></i> <span class="filter-text">All</span>
        </button>
        <button class="filter flex-1 px-3 py-2 rounded-xl border border-slate-800 bg-slate-900/70 hover:bg-slate-800 text-sm flex items-center justify-center gap-1" data-mode="online">
          <span class="w-2 h-2 rounded-full bg-emerald-400"></span> <span class="filter-text">Online</span>
        </button>
        <button class="filter flex-1 px-3 py-2 rounded-xl border border-slate-800 bg-slate-900/70 hover:bg-slate-800 text-sm flex items-center justify-center gap-1" data-mode="offline">
          <span class="w-2 h-2 rounded-full bg-rose-400"></span> <span class="filter-text">Offline</span>
        </button>
      </div>
    </div>

    <div id="deviceList" class="flex-1 overflow-y-auto px-4 pb-4 space-y-3"></div>

    <!-- Icon-only view (always visible) -->
    <div class="hidden" id="iconOnlyView">
      <div class="flex flex-col items-center pt-6 space-y-6">
        <button class="p-3 rounded-xl hover:bg-slate-800"><i class="fa-solid fa-magnifying-glass text-lg"></i></button>
        <button class="p-3 rounded-xl hover:bg-slate-800"><i class="fa-solid fa-sort text-lg"></i></button>
        <button class="p-3 rounded-xl hover:bg-slate-800"><i class="fa-solid fa-eye text-lg"></i></button>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main id="mainContent" class="main-expanded transition-all duration-300">
    <div class="max-w-7xl mx-auto px-6 py-6">

      <!-- Header -->
      <div class="flex items-center justify-between mb-6">
        <p class="text-slate-400">Edge Devices • Crowd Metrics • Live Monitoring</p>
        <div class="flex items-center gap-4">
          <div id="lastUpdate" class="text-xs text-slate-400 flex items-center gap-2">
            <i class="fa-regular fa-clock"></i> <span></span>
          </div>
          <span class="inline-flex items-center gap-2 rounded-full px-4 py-2 text-xs bg-slate-800 border border-slate-700">
            <span class="h-2.5 w-2.5 rounded-full bg-emerald-400 animate-pulse" id="wsDot"></span>
            <span class="font-medium">Live</span>
          </span>
        </div>
      </div>

      <!-- KPIs -->
      <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
        <div class="glass border border-slate-800 rounded-2xl p-5 flex items-center gap-4">
          <div class="p-3 bg-slate-800/50 rounded-xl"><i class="fa-solid fa-server text-xl text-slate-400"></i></div>
          <div><div class="text-sm text-slate-400">Total Devices</div><div id="k_total" class="text-2xl font-bold mt-1">—</div></div>
        </div>
        <div class="glass border border-slate-800 rounded-2xl p-5 flex items-center gap-4">
          <div class="p-3 bg-emerald-500/20 rounded-xl"><i class="fa-solid fa-circle-check text-xl text-emerald-400"></i></div>
          <div><div class="text-sm text-slate-400">Online</div><div id="k_online" class="text-2xl font-bold mt-1 text-emerald-400">—</div></div>
        </div>
        <div class="glass border border-slate-800 rounded-2xl p-5 flex items-center gap-4">
          <div class="p-3 bg-rose-500/20 rounded-xl"><i class="fa-solid fa-circle-xmark text-xl text-rose-400"></i></div>
          <div><div class="text-sm text-slate-400">Offline</div><div id="k_offline" class="text-2xl font-bold mt-1 text-rose-400">—</div></div>
        </div>
        <div class="glass border border-slate-800 rounded-2xl p-5 flex items-center gap-4">
          <div class="p-3 bg-amber-500/20 rounded-xl"><i class="fa-solid fa-users text-xl text-amber-400"></i></div>
          <div><div class="text-sm text-slate-400">Est. Crowd</div><div id="k_sumCount" class="text-2xl font-bold mt-1">—</div></div>
        </div>
        <div class="glass border border-slate-800 rounded-2xl p-5">
          <div class="text-sm text-slate-400 mb-2 flex items-center gap-2"><i class="fa-solid fa-gauge-high"></i> Performance Avg</div>
          <div id="k_perf" class="text-sm font-medium text-slate-300">—</div>
        </div>
      </div>

      <!-- Map & Charts -->
      <div class="glass border border-slate-800 rounded-2xl p-5">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold flex items-center gap-2">
            <i class="fa-solid fa-map-location-dot"></i> Live Map
          </h2>
          <button id="fitMap" class="group rounded-xl border border-slate-800 bg-slate-900/70 px-4 py-2.5 text-sm hover:bg-slate-800 flex items-center gap-2">
            <i class="fa-solid fa-expand group-hover:scale-110 transition-transform"></i> Fit View
          </button>
        </div>

        <div id="map" class="rounded-2xl overflow-hidden border border-slate-800" style="height: 620px;"></div>

        <!-- Legend -->
        <div class="mt-4 flex flex-wrap items-center justify-between gap-4 text-sm">
          <div class="flex flex-wrap gap-3">
            <span class="px-3 py-1.5 rounded-full border border-slate-800 bg-slate-900/50 flex items-center gap-2">
              <span class="inline-block w-3 h-3 rounded-full bg-emerald-400"></span> LOW
            </span>
            <span class="px-3 py-1.5 rounded-full border border-slate-800 bg-slate-900/50 flex items-center gap-2">
              <span class="inline-block w-3 h-3 rounded-full bg-amber-400"></span> MEDIUM
            </span>
            <span class="px-3 py-1.5 rounded-full border border-slate-800 bg-slate-900/50 flex items-center gap-2">
              <span class="inline-block w-3 h-3 rounded-full bg-rose-400"></span> HIGH
            </span>
            <span class="px-3 py-1.5 rounded-full border border-slate-800 bg-slate-900/50 flex items-center gap-2">
              <span class="inline-block w-3 h-3 rounded-full bg-slate-400"></span> OFFLINE
            </span>
          </div>
          <div class="text-xs text-slate-400 flex items-center gap-2">
            <i class="fa-solid fa-info-circle"></i> Click marker for details
          </div>
        </div>

        <!-- Small charts -->
        <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="bg-slate-900/50 border border-slate-800 rounded-2xl p-4">
            <div class="text-sm text-slate-400 mb-3 flex items-center gap-2"><i class="fa-solid fa-chart-pie"></i> Online vs Offline</div>
            <canvas id="chartDonut" height="160"></canvas>
          </div>
          <div class="bg-slate-900/50 border border-slate-800 rounded-2xl p-4">
            <div class="text-sm text-slate-400 mb-3 flex items-center gap-2"><i class="fa-solid fa-location-dot"></i> Top Zones</div>
            <canvas id="chartZones" height="160"></canvas>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Drawer (unchanged) -->
  <div id="drawerBackdrop" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-40"></div>
  <aside id="drawer" class="fixed top-0 right-0 h-full w-full sm:w-[500px] bg-slate-950/95 border-l border-slate-800 translate-x-full transition-transform duration-300 z-50 shadow-2xl">
    <div class="p-6 h-full overflow-y-auto">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-4">
          <div class="p-3 bg-slate-800/50 rounded-xl">
            <i class="fa-solid fa-server text-2xl text-slate-400"></i>
          </div>
          <div>
            <div id="d_title" class="text-xl font-bold">Device</div>
            <div id="d_sub" class="text-sm text-slate-400 mt-1">—</div>
          </div>
        </div>
        <button id="closeDrawer" class="p-3 rounded-xl bg-slate-900/70 border border-slate-800 hover:bg-slate-800 transition-all">
          <i class="fa-solid fa-xmark text-lg"></i>
        </button>
      </div>

      <div class="grid grid-cols-2 gap-3 mt-4">
        <div class="bg-slate-900/50 border border-slate-800 rounded-2xl p-4">
          <div class="text-xs text-slate-400 flex items-center gap-2"><i class="fa-solid fa-users"></i> Final Count</div>
          <div id="d_count" class="text-2xl font-semibold mt-2">—</div>
        </div>
        <div class="bg-slate-900/50 border border-slate-800 rounded-2xl p-4">
          <div class="text-xs text-slate-400 flex items-center gap-2"><i class="fa-solid fa-gauge"></i> YOLO FPS</div>
          <div id="d_fps" class="text-2xl font-semibold mt-2">—</div>
        </div>
        <div class="bg-slate-900/50 border border-slate-800 rounded-2xl p-4">
          <div class="text-xs text-slate-400 flex items-center gap-2"><i class="fa-solid fa-brain"></i> Method</div>
          <div id="d_method" class="text-xl font-semibold mt-2">—</div>
        </div>
        <div class="bg-slate-900/50 border border-slate-800 rounded-2xl p-4">
          <div class="text-xs text-slate-400 flex items-center gap-2"><i class="fa-solid fa-exclamation-triangle"></i> Pressure</div>
          <div class="mt-3"><span id="d_pressure_badge" class="px-3 py-1 rounded-full text-xs border border-slate-700 bg-slate-900">—</span></div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-3 mt-4">
        <div class="bg-slate-900/50 border border-slate-800 rounded-2xl p-4">
          <div class="text-xs text-slate-400">YOLO Count</div>
          <div id="d_yolo_count" class="text-xl font-semibold mt-2">—</div>
        </div>
        <div class="bg-slate-900/50 border border-slate-800 rounded-2xl p-4">
          <div class="text-xs text-slate-400">Dense Scene</div>
          <div id="d_dense" class="text-xl font-semibold mt-2">—</div>
        </div>
        <div class="bg-slate-900/50 border border-slate-800 rounded-2xl p-4">
          <div class="text-xs text-slate-400">IoU Ratio</div>
          <div id="d_iou" class="text-xl font-semibold mt-2">—</div>
        </div>
        <div class="bg-slate-900/50 border border-slate-800 rounded-2xl p-4">
          <div class="text-xs text-slate-400">CSR Time</div>
          <div id="d_csr_time" class="text-xl font-semibold mt-2">—</div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-3 mt-4">
        <div class="bg-slate-900/50 border border-slate-800 rounded-2xl p-4">
          <div class="text-xs text-slate-400 flex items-center gap-2"><i class="fa-solid fa-microchip"></i> CPU</div>
          <div id="d_cpu" class="text-xl font-semibold mt-2">—</div>
        </div>
        <div class="bg-slate-900/50 border border-slate-800 rounded-2xl p-4">
          <div class="text-xs text-slate-400 flex items-center gap-2"><i class="fa-solid fa-temperature-high"></i> Temp</div>
          <div id="d_temp" class="text-xl font-semibold mt-2">—</div>
        </div>
      </div>

      <div class="mt-4 bg-slate-900/50 border border-slate-800 rounded-2xl p-4">
        <div class="text-xs text-slate-400 flex items-center gap-2"><i class="fa-solid fa-bug"></i> CSR Error</div>
        <div id="d_csr_err" class="text-sm text-slate-200 mt-2 break-words">—</div>
      </div>

      <div class="mt-6 bg-slate-900/50 border border-slate-800 rounded-2xl p-4">
        <div class="text-sm text-slate-400 mb-3 flex items-center gap-2"><i class="fa-solid fa-chart-line"></i> Recent Metrics</div>
        <canvas id="chartDevice" height="180"></canvas>
      </div>

      <div class="mt-6 text-sm text-slate-400 space-y-2">
        <div><span class="text-slate-300">Zone:</span> <span id="d_zone">—</span></div>
        <div><span class="text-slate-300">Location:</span> <span id="d_loc">—</span></div>
        <div><span class="text-slate-300">Last Seen:</span> <span id="d_seen">—</span></div>
        <div><span class="text-slate-300">IP:</span> <span id="d_ip">—</span></div>
      </div>
    </div>
  </aside>

  <script src="/socket.io/socket.io.js"></script>

  <script>
    // Toggle Sidebar
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    const logoText = document.getElementById('logoText');
    const sidebarControls = document.getElementById('sidebarControls');
    const deviceList = document.getElementById('deviceList');
    const toggleBtn = document.getElementById('toggleSidebar');
    const filterTexts = document.querySelectorAll('.filter-text');

    toggleBtn.addEventListener('click', () => {
      sidebar.classList.toggle('sidebar-expanded');
      sidebar.classList.toggle('sidebar-collapsed');
      mainContent.classList.toggle('main-expanded');
      mainContent.classList.toggle('main-collapsed');

      if (sidebar.classList.contains('sidebar-collapsed')) {
        logoText.classList.add('hidden');
        sidebarControls.classList.add('hidden');
        deviceList.classList.add('px-2');
        toggleBtn.innerHTML = '<i class="fa-solid fa-chevron-right text-lg"></i>';
        filterTexts.forEach(t => t.classList.add('hidden'));
      } else {
        logoText.classList.remove('hidden');
        sidebarControls.classList.remove('hidden');
        deviceList.classList.remove('px-2');
        toggleBtn.innerHTML = '<i class="fa-solid fa-chevron-left text-lg"></i>';
        filterTexts.forEach(t => t.classList.remove('hidden'));
      }
    });

    // Your entire original JavaScript (unchanged except small fixes)
    let DEVICES = [];
    let filterMode = "all";
    let selectedDeviceId = null;

    const socket = io({ transports: ["websocket","polling"], reconnection: true, reconnectionAttempts: Infinity, reconnectionDelay: 800, reconnectionDelayMax: 3000 });

    function joinDashboard() {
      socket.emit("dashboard:join");
      if (selectedDeviceId) socket.emit("device:join", { deviceId: selectedDeviceId });
    }
    joinDashboard();

    socket.on("connect", () => {
      document.getElementById("wsDot").className = "h-2.5 w-2.5 rounded-full bg-emerald-400 animate-pulse";
      joinDashboard();
    });
    socket.on("disconnect", () => {
      document.getElementById("wsDot").className = "h-2.5 w-2.5 rounded-full bg-rose-400";
    });

    async function fetchSnapshotFallback() {
      try {
        const r = await fetch("/api/devices", { cache: "no-store" });
        const j = await r.json();
        DEVICES = j.devices || [];
        renderKPIs(j.kpis || {});
        renderList();
        lastUpdateEl.querySelector("span").textContent = `Last update: ${new Date(j.ts || Date.now()).toLocaleTimeString()} (REST fallback)`;
      } catch (e) {}
    }
    setInterval(() => { if (!socket.connected) fetchSnapshotFallback(); }, 4000);

    const map = L.map("map").setView([21.4225, 39.8262], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);

    const markers = new Map();
    let selectedMarkerId = null;

    function pressureColor(p) {
      const P = String(p || "").toUpperCase();
      if (P === "HIGH") return "#fb7185";
      if (P === "MEDIUM") return "#fbbf24";
      if (P === "LOW") return "#34d399";
      return "#94a3b8";
    }

    function makeDotIcon(color, isSelected=false) {
      const size = isSelected ? 16 : 12;
      const border = isSelected ? "2px" : "1px";
      const html = `<div style="width:${size}px;height:${size}px;border-radius:999px;background:${color};border:${border} solid rgba(15,23,42,0.9);box-shadow: 0 0 0 3px rgba(148,163,184,0.18);"></div>`;
      return L.divIcon({ className: "", html, iconSize: [size, size], iconAnchor: [size/2, size/2] });
    }

    function markerLabel(d) {
      const m = d.metrics || {};
      const pressure = m.pressure || "—";
      const method = m.method || "—";
      const dense = m.dense_scene === true ? "YES" : (m.dense_scene === false ? "NO" : "—");
      const csrMs = Number.isFinite(m.csr_time_ms) ? `${Math.round(m.csr_time_ms)} ms` : "—";
      return `<b>${escapeHtml(d.name || d.deviceId)}</b><br/>${escapeHtml(d.zone || "")}<br/>Count: ${fmt(m.count)} • YOLO Count: ${fmt(m.yolo_count)}<br/>YOLO FPS: ${fmt(m.yolo_fps ?? m.fps)} • IoU: ${fmt(m.iou_ratio)}<br/>Pressure: ${escapeHtml(pressure)} • Method: ${escapeHtml(method)} • Dense: ${escapeHtml(dense)}<br/>CSR Time: ${escapeHtml(csrMs)}`;
    }

    function setMarkerSelected(deviceId) {
      selectedMarkerId = deviceId;
      for (const [id, mk] of markers.entries()) {
        const d = DEVICES.find(x => x.deviceId === id);
        const online = !!d?.online;
        const color = online ? pressureColor(d?.metrics?.pressure) : "#94a3b8";
        mk.setIcon(makeDotIcon(color, id === selectedMarkerId));
      }
    }

    function upsertMarker(d) {
      if (!d.location) return;
      const key = d.deviceId;
      const latlng = [d.location.lat, d.location.lng];
      const online = !!d.online;
      const color = online ? pressureColor(d.metrics?.pressure) : "#94a3b8";

      if (!markers.has(key)) {
        const mk = L.marker(latlng, { icon: makeDotIcon(color, false) }).addTo(map).bindPopup(markerLabel(d));
        mk.on("click", () => { selectDevice(key); setMarkerSelected(key); });
        markers.set(key, mk);
      } else {
        const mk = markers.get(key);
        mk.setLatLng(latlng);
        mk.setPopupContent(markerLabel(d));
        mk.setIcon(makeDotIcon(color, key === selectedMarkerId));
      }
    }

    document.getElementById("fitMap").addEventListener("click", () => {
      const pts = DEVICES.filter(d => d.location).map(d => [d.location.lat, d.location.lng]);
      if (!pts.length) return;
      map.fitBounds(L.latLngBounds(pts).pad(0.2));
    });

    const donut = new Chart(document.getElementById("chartDonut"), {
      type: "doughnut",
      data: { labels: ["Online", "Offline"], datasets: [{ data: [0,0], backgroundColor: ["#34d399", "#f87171"] }] },
      options: { plugins: { legend: { labels: { color: "#cbd5e1" } } } }
    });

    const zonesBar = new Chart(document.getElementById("chartZones"), {
      type: "bar",
      data: { labels: [], datasets: [{ label: "Devices", data: [], backgroundColor: "#10b981" }] },
      options: { plugins: { legend: { labels: { color: "#cbd5e1" } } }, scales: { x: { ticks: { color: "#94a3b8" }, grid: { color: "rgba(148,163,184,0.15)" } }, y: { ticks: { color: "#94a3b8" }, grid: { color: "rgba(148,163,184,0.15)" } } } }
    });

    const deviceLine = new Chart(document.getElementById("chartDevice"), {
      type: "line",
      data: { labels: [], datasets: [{ label: "Count", data: [], borderColor: "#34d399", tension: 0.3 }, { label: "YOLO FPS", data: [], borderColor: "#fbbf24", tension: 0.3 }, { label: "IoU Ratio", data: [], borderColor: "#60a5fa", tension: 0.3 }] },
      options: { plugins: { legend: { labels: { color: "#cbd5e1" } } }, scales: { x: { ticks: { color: "#94a3b8" }, grid: { color: "rgba(148,163,184,0.15)" } }, y: { ticks: { color: "#94a3b8" }, grid: { color: "rgba(148,163,184,0.15)" } } } }
    });

    const listEl = document.getElementById("deviceList");
    const searchEl = document.getElementById("search");
    const lastUpdateEl = document.getElementById("lastUpdate");
    const sortEl = document.getElementById("sortBy");
    const onlyOnlineEl = document.getElementById("onlyOnline");

    sortEl.addEventListener("change", renderList);
    onlyOnlineEl.addEventListener("change", renderList);
    searchEl.addEventListener("input", renderList);

    function pressureRank(p) { const P = String(p || "").toUpperCase(); if (P === "HIGH") return 3; if (P === "MEDIUM") return 2; if (P === "LOW") return 1; return 0; }

    function badgePressure(p) {
      const P = String(p || "").toUpperCase();
      if (P === "HIGH") return `bg-rose-500/15 border-rose-500/30 text-rose-200`;
      if (P === "MEDIUM") return `bg-amber-500/15 border-amber-500/30 text-amber-200`;
      if (P === "LOW") return `bg-emerald-500/15 border-emerald-500/30 text-emerald-200`;
      return `bg-slate-900 border-slate-800 text-slate-200`;
    }

    function timeAgo(ms) {
      if (!ms) return "—";
      const s = Math.max(0, Math.floor((Date.now() - ms) / 1000));
      if (s < 60) return `${s}s ago`;
      const m = Math.floor(s/60);
      if (m < 60) return `${m}m ago`;
      const h = Math.floor(m/60);
      return `${h}h ago`;
    }

    function passesFilter(d) {
      if (filterMode === "online") return d.online;
      if (filterMode === "offline") return !d.online;
      return true;
    }

    function renderKPIs(k) {
      document.getElementById("k_total").textContent = k.total ?? "—";
      document.getElementById("k_online").textContent = k.online ?? "—";
      document.getElementById("k_offline").textContent = k.offline ?? "—";
      document.getElementById("k_sumCount").textContent = (k.sumCount ?? "—");
      const avgYoloFps = k.avgYoloFps ?? "—";
      const avgIoU = k.avgIoURatio ?? "—";
      const avgCpu = k.avgCpu ?? "—";
      const avgTemp = k.avgTemp ?? "—";
      document.getElementById("k_perf").textContent = `${avgYoloFps} yolo-fps • IoU ${avgIoU} • ${avgCpu}% CPU • ${avgTemp}°C`;
      donut.data.datasets[0].data = [k.online || 0, k.offline || 0];
      donut.update();
    }

    function renderZoneChart(devs) {
      const zones = {};
      devs.forEach(d => { zones[d.zone || "Unassigned"] = (zones[d.zone || "Unassigned"] || 0) + 1; });
      const items = Object.entries(zones).sort((a,b)=>b[1]-a[1]).slice(0,6);
      zonesBar.data.labels = items.map(x=>x[0]);
      zonesBar.data.datasets[0].data = items.map(x=>x[1]);
      zonesBar.update();
    }

    function renderList() {
      const q = (searchEl.value || "").toLowerCase().trim();
      const onlyOnline = !!onlyOnlineEl.checked;

      let filtered = DEVICES
        .filter(d => !onlyOnline || d.online)
        .filter(d => passesFilter(d))
        .filter(d => (d.name || "").toLowerCase().includes(q) || (d.deviceId || "").toLowerCase().includes(q) || (d.zone || "").toLowerCase().includes(q));

      const sortBy = sortEl.value;
      filtered.sort((a, b) => {
        const onlineCmp = Number(b.online) - Number(a.online);
        if (onlineCmp) return onlineCmp;
        if (sortBy === "pressure") {
          const pr = pressureRank(b.metrics?.pressure) - pressureRank(a.metrics?.pressure);
          if (pr) return pr;
          return (Number(b.metrics?.count || 0) - Number(a.metrics?.count || 0));
        }
        if (sortBy === "count") {
          const c = (Number(b.metrics?.count || 0) - Number(a.metrics?.count || 0));
          if (c) return c;
          return (a.name || "").localeCompare(b.name || "");
        }
        if (sortBy === "seen") {
          return (Number(b.lastSeen || 0) - Number(a.lastSeen || 0));
        }
        return (a.name || "").localeCompare(b.name || "");
      });

      const groups = {};
      for (const d of filtered) {
        const z = d.zone || "Unassigned";
        if (!groups[z]) groups[z] = [];
        groups[z].push(d);
      }
      const zoneNames = Object.keys(groups).sort((a,b)=>a.localeCompare(b));

      listEl.innerHTML = zoneNames.map(zone => {
        const items = groups[zone];
        const onlineCount = items.filter(x => x.online).length;

        const cards = items.map(d => {
          const m = d.metrics || {};
          const isSelected = d.deviceId === selectedDeviceId;
          const dim = d.online ? "" : "opacity-70";
          const ring = isSelected ? "ring-2 ring-emerald-400/60" : "";
          const bg = isSelected ? "bg-slate-900/80" : "bg-slate-900/40";

          const count = fmt(m.count);
          const yoloFps = fmt(m.yolo_fps ?? m.fps);
          const yoloCount = fmt(m.yolo_count);
          const iou = fmt(m.iou_ratio);
          const dense = m.dense_scene === true ? "YES" : (m.dense_scene === false ? "NO" : "—");
          const method = m.method || "—";
          const pressure = m.pressure || "—";
          const csrMs = Number.isFinite(m.csr_time_ms) ? `${Math.round(m.csr_time_ms)} ms` : "—";
          const cpu = Number.isFinite(m.cpu) ? `${Math.round(m.cpu)}%` : "—";
          const temp = Number.isFinite(m.temp) ? `${Math.round(m.temp)}°C` : "—";

          const onlineBadge = d.online
            ? `<span class="px-2 py-1 rounded-full text-[11px] bg-emerald-500/15 border border-emerald-500/30 text-emerald-200 flex items-center gap-1"><i class="fa-solid fa-circle-dot text-xs"></i>ONLINE</span>`
            : `<span class="px-2 py-1 rounded-full text-[11px] bg-rose-500/15 border border-rose-500/30 text-rose-200 flex items-center gap-1"><i class="fa-solid fa-circle-dot text-xs"></i>OFFLINE</span>`;

          return `
            <button class="w-full text-left rounded-2xl border border-slate-800 ${bg} hover:bg-slate-900/70 transition p-4 ${ring} ${dim}"
                    onclick="selectDevice('${escapeAttr(d.deviceId)}'); setMarkerSelected('${escapeAttr(d.deviceId)}');">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <div class="font-semibold text-base">${escapeHtml(d.name || d.deviceId)}</div>
                  <div class="text-xs text-slate-400 mt-1">${escapeHtml(d.deviceId)}</div>
                </div>
                ${onlineBadge}
              </div>

              <div class="mt-3 flex flex-wrap gap-2 text-[11px]">
                <span class="px-3 py-1 rounded-full border ${badgePressure(pressure)}">${escapeHtml(pressure)}</span>
                <span class="px-3 py-1 rounded-full border border-slate-800 bg-slate-950/30">Method: ${escapeHtml(method)}</span>
                <span class="px-3 py-1 rounded-full border border-slate-800 bg-slate-950/30">Dense: ${escapeHtml(dense)}</span>
              </div>

              <div class="grid grid-cols-3 gap-3 mt-4 text-sm">
                <div class="bg-slate-950/40 border border-slate-800 rounded-xl p-3">
                  <div class="text-slate-400 text-xs">Final Count</div><div class="font-bold">${count}</div>
                </div>
                <div class="bg-slate-950/40 border border-slate-800 rounded-xl p-3">
                  <div class="text-slate-400 text-xs">YOLO FPS</div><div class="font-bold">${yoloFps}</div>
                </div>
                <div class="bg-slate-950/40 border border-slate-800 rounded-xl p-3">
                  <div class="text-slate-400 text-xs">IoU</div><div class="font-bold">${iou}</div>
                </div>
              </div>

              <div class="grid grid-cols-3 gap-3 mt-3 text-sm">
                <div class="bg-slate-950/40 border border-slate-800 rounded-xl p-3">
                  <div class="text-slate-400 text-xs">YOLO Count</div><div class="font-bold">${yoloCount}</div>
                </div>
                <div class="bg-slate-950/40 border border-slate-800 rounded-xl p-3">
                  <div class="text-slate-400 text-xs">CSR Time</div><div class="font-bold">${csrMs}</div>
                </div>
                <div class="bg-slate-950/40 border border-slate-800 rounded-xl p-3">
                  <div class="text-slate-400 text-xs">CPU / Temp</div><div class="font-bold">${cpu} / ${temp}</div>
                </div>
              </div>

              <div class="grid grid-cols-2 gap-3 mt-3 text-xs">
                <div class="bg-slate-950/40 border border-slate-800 rounded-xl p-3">
                  <div class="text-slate-400">Seen</div><div class="font-semibold">${timeAgo(d.lastSeen)}</div>
                </div>
                <div class="bg-slate-950/40 border border-slate-800 rounded-xl p-3">
                  <div class="text-slate-400">CSR Error</div><div class="font-semibold truncate">${escapeHtml(m.csr_error || "—")}</div>
                </div>
              </div>
            </button>
          `;
        }).join("");

        return `
          <details class="rounded-2xl border border-slate-800 bg-slate-900/20 overflow-hidden" open>
            <summary class="cursor-pointer select-none px-4 py-3 flex items-center justify-between hover:bg-slate-800/30 transition">
              <div class="font-semibold flex items-center gap-2">
                <i class="fa-solid fa-location-dot text-sm"></i>
                ${escapeHtml(zone)}
              </div>
              <div class="text-xs text-slate-400">${onlineCount}/${items.length} online</div>
            </summary>
            <div class="p-4 space-y-3">${cards}</div>
          </details>
        `;
      }).join("");

      DEVICES.forEach(upsertMarker);
      renderZoneChart(DEVICES);
    }

    document.querySelectorAll(".filter").forEach(btn => {
      btn.addEventListener("click", () => {
        filterMode = btn.dataset.mode;
        document.querySelectorAll(".filter").forEach(b => b.classList.remove("ring-2","ring-slate-400"));
        btn.classList.add("ring-2","ring-slate-400");
        renderList();
      });
    });

    const drawer = document.getElementById("drawer");
    const backdrop = document.getElementById("drawerBackdrop");
    document.getElementById("closeDrawer").onclick = closeDrawer;
    backdrop.onclick = closeDrawer;

    function openDrawer() {
      backdrop.classList.remove("hidden");
      drawer.classList.remove("translate-x-full");
    }
    function closeDrawer() {
      backdrop.classList.add("hidden");
      drawer.classList.add("translate-x-full");
      selectedDeviceId = null;
      selectedMarkerId = null;
      setMarkerSelected(null);
      renderList();
    }

    window.selectDevice = async (deviceId) => {
      selectedDeviceId = deviceId;
      socket.emit("device:join", { deviceId });
      setMarkerSelected(deviceId);

      const res = await fetch(`/api/devices/${encodeURIComponent(deviceId)}`, { cache: "no-store" });
      const json = await res.json();
      fillDrawer(json.device, json.online);
      openDrawer();
      renderList();

      if (json.device.location) {
        map.setView([json.device.location.lat, json.device.location.lng], 16);
        const mk = markers.get(deviceId);
        if (mk) mk.openPopup();
      }
    };

    socket.on("device:update", ({ device, online }) => {
      if (device?.deviceId === selectedDeviceId) fillDrawer(device, online);
    });

    function setPressureBadge(p) {
      const el = document.getElementById("d_pressure_badge");
      el.textContent = p || "—";
      el.className = `px-4 py-2 rounded-full text-sm font-medium border ${badgePressure(p)}`;
    }

    function fillDrawer(d, online) {
      document.getElementById("d_title").textContent = d.name || d.deviceId;
      document.getElementById("d_sub").textContent = `${online ? "ONLINE" : "OFFLINE"} • ${d.deviceId}`;
      const m = d.metrics || {};
      document.getElementById("d_count").textContent = fmt(m.count);
      document.getElementById("d_fps").textContent = fmt(m.yolo_fps ?? m.fps);
      document.getElementById("d_method").textContent = m.method || "—";
      setPressureBadge(m.pressure);
      document.getElementById("d_yolo_count").textContent = fmt(m.yolo_count);
      document.getElementById("d_dense").textContent = m.dense_scene === true ? "YES" : (m.dense_scene === false ? "NO" : "—");
      document.getElementById("d_iou").textContent = fmt(m.iou_ratio);
      document.getElementById("d_csr_time").textContent = Number.isFinite(m.csr_time_ms) ? `${Math.round(m.csr_time_ms)} ms` : "—";
      document.getElementById("d_cpu").textContent = Number.isFinite(m.cpu) ? `${Math.round(m.cpu)}%` : "—";
      document.getElementById("d_temp").textContent = Number.isFinite(m.temp) ? `${Math.round(m.temp)}°C` : "—";
      document.getElementById("d_csr_err").textContent = m.csr_error || "—";
      document.getElementById("d_zone").textContent = d.zone || "Unassigned";
      document.getElementById("d_loc").textContent = d.location ? `${d.location.lat.toFixed(5)}, ${d.location.lng.toFixed(5)}` : "—";
      document.getElementById("d_seen").textContent = new Date(d.lastSeen).toLocaleString();
      document.getElementById("d_ip").textContent = d.ip || "—";

      const hist = (d.history || []).slice(-40);
      deviceLine.data.labels = hist.map(h => new Date((h.ts || 0) * 1000).toLocaleTimeString());
      deviceLine.data.datasets[0].data = hist.map(h => (Number.isFinite(h.count) ? h.count : null));
      deviceLine.data.datasets[1].data = hist.map(h => (Number.isFinite(h.yolo_fps) ? h.yolo_fps : null));
      deviceLine.data.datasets[2].data = hist.map(h => (Number.isFinite(h.iou_ratio) ? h.iou_ratio : null));
      deviceLine.update();

      setMarkerSelected(d.deviceId);
    }

    function fmt(v) { return Number.isFinite(v) ? (Math.round(v * 10) / 10) : "—"; }
    function escapeHtml(s) { return String(s || "").replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }
    function escapeAttr(s) { return String(s || "").replace(/'/g, "\\'"); }

    socket.on("dashboard:update", ({ devices, kpis, ts }) => {
      DEVICES = devices || [];
      renderKPIs(kpis || {});
      renderList();
      lastUpdateEl.querySelector("span").textContent = `Last update: ${new Date(ts || Date.now()).toLocaleTimeString()}`;
    });
  </script>
</body>
</html>